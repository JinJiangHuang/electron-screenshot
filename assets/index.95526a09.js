import{r as e,a as t,s as n,d as a,t as o,c as i,w as s,b as l,e as r,f as c,g as u,p as d,h,o as m,i as p,j as v,k as f,F as b,l as x,m as w,n as E,q as y,u as g,v as M,x as R,y as _,z as L}from"./vendor.ca5625c0.js";let C;!function(e=".",t="__import__"){try{self[t]=new Function("u","return import(u)")}catch(n){const a=new URL(e,location),o=e=>{URL.revokeObjectURL(e.src),e.remove()};self[t]=e=>new Promise(((n,i)=>{const s=new URL(e,a);if(self[t].moduleMap[s])return n(self[t].moduleMap[s]);const l=new Blob([`import * as m from '${s}';`,`${t}.moduleMap['${s}']=m;`],{type:"text/javascript"}),r=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(l),onerror(){i(new Error(`Failed to import: ${e}`)),o(r)},onload(){n(self[t].moduleMap[s]),o(r)}});document.head.appendChild(r)})),self[t].moduleMap={}}}("assets/");const O={},k=new Image,I=e(!1),T=t({x:{min:0,max:0},y:{min:0,max:0}}),S=t({x:-999,y:-999,h:0,w:0}),A=e(null),P=e(null),U=n([]),j=e(null);function N(e=U){if(0===e.length)return void(j.value=null);null!=j.value||(j.value={x:{min:0,max:0},y:{min:0,max:0}});const t=e.reduce(((e,{path:t})=>(t&&e.push(...t),e)),[]),[n,a]=t.reduce(((e,[t,n])=>(e[0].push(t),e[1].push(n),e)),[[],[]]);j.value.x.min=Math.min(...n),j.value.x.max=Math.max(...n),j.value.y.min=Math.min(...a),j.value.y.max=Math.max(...a),console.log(j.value)}const z=e(null),D=Math.PI/6;function B(e,t,n=10,a=30,o){const{height:i,width:s}=e.canvas,l=((e,t,n,a)=>n.reduce(((n,[o,i])=>{const[s,l]=[Math.max(0,o-a),Math.min(o+a,e)],[r,c]=[Math.max(0,i-a),Math.min(i+a,t)];for(let t=r;t<c;t++)for(let r=s;r<l;r++)(r-o)**2+(t-i)**2<a**2&&(n[t*e+r]=!0);return n}),Array(e*t).fill(!1)))(s,i,t,a/2),[r,c]=[Math.ceil(s/n),Math.ceil(i/n)],u=e.getImageData(0,0,s,i).data,d=new Uint8ClampedArray(s*i*4);for(let h=0;h<c;h++){const[e,t]=[h*n,Math.min((h+1)*n,i)];for(let a=0;a<r;a++){const[i,c]=[a*n,Math.min((a+1)*n,s)],m=4*(h*r+a),[p,v,f,b]=[o[m],o[m+1],o[m+2],255];for(let n=e;n<t;n++)for(let e=i;e<c;e++){const t=n*s+e,a=4*t;l[t]?(d[a]=p,d[a+1]=v,d[a+2]=f,d[a+3]=b):(d[a]=u[a],d[a+1]=u[a+1],d[a+2]=u[a+2],d[a+3]=u[a+3])}}}e.putImageData(new ImageData(d,s,i),0,0)}const W=e=>new Promise(((t,n)=>e.toBlob((e=>e?t(e):n(new Error("Failed to convert file"))))));function $(e,t,n,a,o){const i=document.createElement("canvas");Object.assign(i,{height:o,width:a});return i.getContext("2d").drawImage(e,t,n,a,o,0,0,a,o),i}function V(e,t=P.value.getContext("2d"),n=k){t.clearRect(0,0,T.x.max,T.y.max),t.drawImage(n,0,0),e.forEach((e=>{switch(e.id){case"LINE":{const[n,a]=e.path;!function(e,t,n,a,o){e.lineWidth=a,e.strokeStyle=o,e.lineCap="round",e.beginPath(),e.moveTo(...t),e.lineTo(...n),e.stroke()}(t,n,a,1,"red");break}case"RECT":{const[n,a]=e.path;!function(e,t,n,a,o){const[[i,s],[l,r]]=[t,n],c=[t,[i,r],n,[l,s]];e.beginPath(),e.moveTo(...t),c.slice(1).forEach((t=>e.lineTo(...t))),e.closePath(),e.lineWidth=a,e.strokeStyle=o,e.stroke()}(t,n,a,1,"red");break}case"ARROW":{const[n,a]=e.path;!function(e,t,n,a,o){const[i,s]=t,[l,r]=n,c=Math.atan((s-r)/(i-l)),u=Math.abs((l-i)/(Math.cos(c)*Math.cos(D))),d=Math.min(u,6+2*a),h=l<i?-1:1,[m,p]=[l-Math.cos(c-D)*d*h,r-Math.sin(c-D)*d*h],[v,f]=[l-Math.cos(c+D)*d*h,r-Math.sin(c+D)*d*h],[b,x]=[(v-m)/3,(f-p)/3],[w,E]=[m+b,p+x],[y,g]=[v-b,f-x],M=[[i,s],[w,E],[m,p],[l,r],[v,f],[y,g]];e.beginPath(),e.moveTo(i,s),M.slice(1).forEach((t=>e.lineTo(...t))),e.closePath(),e.fillStyle=o,e.fill()}(t,n,a,4,"red");break}case"ELLIPSE":{const[n,a]=e.path;!function(e,t,n,a,o){const[[i,s],[l,r]]=[t,n],[c,u]=[i-l,s-r].map((e=>Math.abs(e/2))),[d,h]=[(i+l)/2,(s+r)/2],m=Math.max(c,u),[p,v]=[c/m,u/m];e.save(),e.scale(p,v),e.beginPath(),e.arc(d/p,h/v,m,0,2*Math.PI),e.closePath(),e.restore(),e.lineWidth=a,e.strokeStyle=o,e.stroke()}(t,n,a,1,"red");break}case"BRUSH":!function(e,t,n,a){if(t.length<2)return;e.lineWidth=n,e.strokeStyle=a,e.lineCap="round",e.beginPath();let o=t[0];e.moveTo(...o);for(let i=1;i<t.length-1;i++){const[[n,a],[s,l]]=t.slice(i,i+2),[r,c]=[n+(s-n)/2,a+(l-a)/2];e.quadraticCurveTo(n,a,r,c),o=[r,c]}e.lineTo(...t.slice(-1)[0]),e.stroke(),e.closePath()}(t,e.path,4,"red");break;case"MOSAIC":B(t,e.path,10,30,z.value)}}))}function H(e){let t=!1;return function(...n){t||(t=!0,window.requestAnimationFrame((()=>{e.apply(this,n),t=!1})))}}async function q(e,t=document.title){var n,a;if(!("Notification"in window))throw new Error("This browser does not support notification");if("granted"===Notification.permission)return e.icon||(e.icon=null!=(a=null==(n=document.querySelector("link[rel*=icon]"))?void 0:n.getAttribute("href"))?a:void 0),new Notification(t,e);if("denied"===Notification.permission)throw new Error("notification permission denied");return await Notification.requestPermission(),await q(e,t)}const F=()=>navigator.mediaDevices.getDisplayMedia().then((e=>new Promise(((t,n)=>{const a=document.createElement("video");a.setAttribute("autoplay","true"),((e=0)=>new Promise((t=>setTimeout(t,e))))(1e3).then(n),a.onplay=()=>t(a),a.srcObject=e})))).then((e=>{var t;const{videoHeight:n,videoWidth:a}=e,o=document.createElement("canvas");Object.assign(o,{height:n,width:a}),null==(t=o.getContext("2d"))||t.drawImage(e,0,0);return e.srcObject.getTracks().forEach((e=>e.stop())),e.srcObject=null,W(o)})),Z=10,G=10,[X,J]=[120,88],[K,Q]=[X/4,J/4];var Y=a({props:{mousePoint:{type:Object,required:!0},canvas:{type:Object,required:!0}},setup(t){const{mousePoint:n,canvas:a}=o(t),l=e(null),r=i((()=>{const e={};if(n.value){const[t,a]=n.value,[o,i]=[Z+120,G+120],s=t+o>T.x.max?t-o:t+Z,l=a+i>T.y.max?a-i:a+G;e.left=`${s}px`,e.top=`${l}px`}return e}));return s(n,H((e=>{if(!e||!a.value||!l.value)return;const[t,n]=e,o=l.value.getContext("2d");o.clearRect(0,0,X,J),o.drawImage(a.value,t-K/2,n-Q/2,K,Q,0,0,X,J)}))),document.body.style,{canvasRef:l,DW:X,DH:J,style:r}}});const ee=u("data-v-515d9b03");d("data-v-515d9b03");const te={class:"capture-info__view"},ne=r("svg",{viewBox:"0 0 120 88",xmlns:"http://www.w3.org/2000/svg",fill:"none"},[r("path",{d:"M 0 1 H 119 V87 H1 V1",stroke:"red","stroke-width":"2"}),r("path",{d:"M 0 44 H 119",stroke:"red","stroke-width":"2"}),r("path",{d:"M 60 0 V 88",stroke:"red","stroke-width":"2"})],-1),ae={class:"capture-info__p"};h();const oe=ee(((e,t)=>(m(),l("div",{class:"capture-info__wrap",style:e.style},[r("div",te,[r("canvas",{ref:"canvasRef",width:e.DW,height:e.DH},null,8,["width","height"]),ne]),r("div",ae,[c(e.$slots,"default")])],4))));Y.render=oe,Y.__scopeId="data-v-515d9b03";const ie=function(e){for(const t of e){const e=t.target.__resizeListeners__||[];e.length&&e.forEach((e=>{e()}))}},se=function(e,t){e&&(e.__resizeListeners__||(e.__resizeListeners__=[],e.__ro__=new p(ie),e.__ro__.observe(e)),e.__resizeListeners__.push(t))},le=function(e,t){e&&e.__resizeListeners__&&(e.__resizeListeners__.splice(e.__resizeListeners__.indexOf(t),1),e.__resizeListeners__.length||e.__ro__.disconnect())};let re=null;function ce(e=document.getElementsByTagName("head")[0]){const t=document.createElement("style");return t.media="screen",e.appendChild(t),t}function ue(e,t,n=function(){return null!=re?re:re=ce()}()){n&&t&&n.sheet.insertRule(e+"{"+t+"}",0)}const de=(e,t=new Image)=>new Promise(((n,a)=>{t.onload=()=>n(t),t.onerror=e=>a(e),t.src=e})),he=(e=new Image)=>((e="image/png")=>new Promise(((t,n)=>{const a=document.createElement("input");Object.assign(a,{accept:e,type:"file"}),a.onchange=()=>{var e;const o=null==(e=a.files)?void 0:e[0];(null==o?void 0:o.type.startsWith("image/"))?t(o):n()},a.click()})))().then((t=>de(URL.createObjectURL(t),e))),me=0,pe=6,ve=[{icon:"A",label:"添加文字(TODO)",id:"TEXT",cursor:"text"},{icon:"⬜",label:"矩形工具",id:"RECT"},{icon:"⚪",label:"椭圆工具",id:"ELLIPSE"},{icon:"╱",label:"直线工具",id:"LINE"},{icon:"↗",label:"箭头工具",id:"ARROW"},{icon:"🖊",label:"笔刷工具",id:"BRUSH"},{icon:"🐴",label:"马赛克工具",id:"MOSAIC"}],fe=[{icon:"↩",label:"撤销",id:"RETURN"},{icon:"⚡",label:"更换底图(使用本地文件)",id:"USE_UPLOAD_FILE"},{icon:"✂",label:"更换底图(使用屏幕快照)",id:"USE_SCREEN_CAPTURE"},{icon:"⬇",label:"保存(下载图片)",id:"SAVE"},{icon:"❌",label:"取消",id:"CANCEL"},{icon:"✔",label:"确定(复制到剪切板)",id:"CONFIRM"}];var be=a({name:"ToolBox",emits:["dispatch"],setup(n,a){const o=e(null),s=t({w:0,h:0}),l=i((()=>{const e={};if(I.value&&"CREATE"!==A.value){const{x:t,y:n,w:a,h:o}=S,i=n+o+pe+s.h+pe>T.y.max?Math.max(n-s.h-pe,T.y.min):n+o+pe,l=Math.max(t+a-s.w-me,T.x.min+me);e.left=`${l}px`,e.top=`${i}px`}else e.visibility="hidden";return e})),r=H((function(){const{width:e,height:t}=o.value.getBoundingClientRect();Object.assign(s,{w:e,h:t})}));return v((()=>{se(o.value,r)})),f((()=>{le(o.value,r)})),{TOOL_ACTIONS:ve,OPT_ACTIONS:fe,style:l,action:A,handleExecCmd:function e(t){switch(t){case"SAVE":{const{x:e,y:t,w:n,h:a}=S;!function(e,t,n,a,o){const i=$(e,t,n,a,o),s=i.toDataURL("image/png");W(i).then(console.log);const l=document.createElement("a");l.download=`导出图片${Date.now()}.png`,l.href=s,l.click()}(P.value,e,t,n,a);break}case"CONFIRM":{const{x:e,y:t,w:a,h:o}=S;(n=$(P.value,e,t,a,o),navigator.permissions.query({name:"clipboard-write"}).then((async({state:e})=>{if("granted"!==e)throw new Error("clipboard-permissoin not granted");return W(n).then((e=>{const{type:t}=e;return navigator.clipboard.write([new ClipboardItem({[t]:e})])}))}))).then((()=>{q({body:"图片已复制"},"提示")}),(e=>{var t;q({body:null!=(t=null==e?void 0:e.message)?t:"图片复制失败"},"提示")}));break}case"RETURN":if(0===U.length)break;U.pop(),V(U),N();break;case"CANCEL":U.length=1,e("RETURN"),Object.assign(S,{x:-999,y:-999,h:0,w:0});break;case"USE_UPLOAD_FILE":{const e=k.src;he(k).then((()=>{U.length=0,V(U),URL.revokeObjectURL(e)}));break}case"USE_SCREEN_CAPTURE":{const e=k.src;((e=new Image)=>F().then((t=>de(URL.createObjectURL(t),e))))(k).then((()=>{U.length=0,V(U),URL.revokeObjectURL(e)}));break}default:return void console.log("TODO EXEC CMD => ",t)}var n;a.emit("dispatch",t)},handleUpdateTool:function(e){A.value=A.value===e?null:e},toolBoxRef:o}}});const xe=r("div",{class:"tool-divider"},null,-1);be.render=function(e,t){return m(),l("div",{ref:"toolBoxRef",class:"tool-box",style:e.style},[(m(!0),l(b,null,x(e.TOOL_ACTIONS,(t=>(m(),l("button",{key:t.id,class:["tool-item",e.action===t.id&&"active"],title:t.label,onClick:n=>e.handleUpdateTool(t.id)},w(t.icon),11,["title","onClick"])))),128)),xe,(m(!0),l(b,null,x(e.OPT_ACTIONS,(t=>(m(),l("button",{key:t.id,class:"tool-item",title:t.label,onClick:n=>e.handleExecCmd(t.id)},w(t.icon),9,["title","onClick"])))),128))],4)};const we=Object.freeze(["CREATE","MOVE","RESIZE"]),Ee=Object.freeze(["TEXT","RECT","ELLIPSE","LINE","ARROW","BRUSH","MOSAIC"]);Object.freeze(["RETURN","SAVE","CANCEL","CONFIRM"]);const ye=[{position:["top"],cursor:"ns-resize"},{position:["bottom"],cursor:"ns-resize"},{position:["left"],cursor:"ew-resize"},{position:["right"],cursor:"ew-resize"},{position:["top","left"],cursor:"nwse-resize"},{position:["bottom","right"],cursor:"nwse-resize"},{position:["top","right"],cursor:"nesw-resize"},{position:["bottom","left"],cursor:"nesw-resize"}];var ge=a({name:"App",components:{InfoBox:Y,ToolBox:be},setup(){const t=e(null);let n=null;const a=e(null),o=e("0, 0, 0");let l=E.cloneDeep(S),r=[],c=null;const u=i((()=>A.value&&["CREATE","RESIZE"].includes(A.value))),d=i((()=>{const{x:e,y:t,h:n,w:a}=S,[o,i,s,l]=[e,t,n,a].map((e=>`${e}px`)),r={left:o,top:i,height:s,width:l,cursor:""};return A.value||(r.cursor="move"),r})),h=i((()=>{var e;return null==(e=P.value)?void 0:e.getContext("2d")}));s(a,H((e=>{if(!h.value||!e)return;const{data:t}=h.value.getImageData(e[0],e[1],1,1);o.value=t.slice(0,3).join(", ")})));const m=H((async function(){const{clientHeight:e,clientWidth:t}=document.body;T.x.max=t,T.y.max=e,await y(),V(U,h.value,k)}));function p(e){I.value=!0;const{x:t,y:n}=e;Object.assign(S,{x:t,y:n}),A.value="CREATE",ue("*","cursor: crosshair !important;",c=ce()),x(e)}const b=H((function(e){var t,o,i,s,c,u,d,m;if(!n||!A.value)return;const[p,v]=n;let f=Math.min(Math.max(e.x,T.x.min),T.x.max),b=Math.min(Math.max(e.y,T.y.min),T.y.max);const[x,w]=[f-p,b-v];a.value=[f,b];const[y]=U.slice(-1);if(we.includes(A.value))switch(A.value){case"CREATE":const[e,n]=[Math.min(p,f),Math.min(v,b)],[a,h]=[Math.abs(x),Math.abs(w)],[E,y]=[Math.min(a,T.x.max-e),Math.min(h,T.y.max-n)];Object.assign(S,{x:e,y:n,w:E,h:y});break;case"MOVE":{const{x:e,y:n}=l,{h:a,w:r}=S,c=j.value;S.x=Math.min(Math.max(e+x,T.x.min,(null!=(t=null==c?void 0:c.x.max)?t:-1/0)-r),T.x.max-r,null!=(o=null==c?void 0:c.x.min)?o:1/0),S.y=Math.min(Math.max(n+w,T.y.min,(null!=(i=null==c?void 0:c.y.max)?i:-1/0)-a),T.y.max-a,null!=(s=null==c?void 0:c.y.min)?s:1/0);break}case"RESIZE":{const{h:e,y:t,w:n,x:a}=l,o=j.value;r.includes("top")?(b=Math.min(b,null!=(c=null==o?void 0:o.y.min)?c:1/0),S.y=Math.min(b,t+e),S.h=Math.abs(t-b+e)):r.includes("bottom")&&(b=Math.max(b,null!=(u=null==o?void 0:o.y.max)?u:-1/0),S.y=Math.min(b,t),S.h=Math.abs(b-t)),r.includes("left")?(f=Math.min(f,null!=(d=null==o?void 0:o.x.min)?d:1/0),S.x=Math.min(f,a+n),S.w=Math.abs(a-f+n)):r.includes("right")&&(f=Math.max(f,null!=(m=null==o?void 0:o.x.max)?m:-1/0),S.x=Math.min(f,a),S.w=Math.abs(f-a));break}}else if(Ee.includes(A.value)){if((null==y?void 0:y.id)!==A.value)return;const e=function([e,t]){const{x:n,y:a,w:o,h:i}=S;return[Math.max(Math.min(e,n+o),n),Math.max(Math.min(t,a+i),a)]}([f,b]),[t]=y.path.slice(-1);if(E.isEqual(e,t))return;switch(A.value){case"LINE":case"RECT":case"ARROW":case"ELLIPSE":y.path[1]=e;break;case"BRUSH":case"MOSAIC":y.path.push(e);break;default:return}V(U,h.value,k)}}));function x(e){l=E.cloneDeep(S),e.stopImmediatePropagation();const{x:t,y:o}=e;n=[t,o],a.value=[t,o],document.addEventListener("mousemove",b),document.addEventListener("mouseup",w),document.onselectstart=()=>!1}function w(){var e;n=null,document.onselectstart=null,null==(e=null==c?void 0:c.parentNode)||e.removeChild(c),document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",w),"MOSAIC"===A.value&&(z.value=null),we.includes(A.value)&&(A.value=null),N()}function g(){I.value=!1,function(e,t,n){const a=function(o){n&&n.call(this,o),function(e,t,n){e&&t&&n&&e.removeEventListener(t,n,!1)}(e,t,a)};!function(e,t,n,a=!1){e&&t&&n&&e.addEventListener(t,n,a)}(e,t,a)}(t.value,"mousedown",p)}return v((()=>{se(document.body,m),g()})),f((()=>{le(document.body,m)})),{startCapture:p,onMousedownCaptureLayer:function(e){A.value?Ee.includes(A.value)&&(U.push({id:A.value,path:[[e.x,e.y]]}),"MOSAIC"===A.value&&(z.value=function(e,t=10){const{width:n,height:a}=e.canvas,[o,i]=[Math.ceil(n/t),Math.ceil(a/t)],s=e.getImageData(0,0,n,a).data,l=new Uint8ClampedArray(o*i*4);for(let r=0;r<o*i;r++){const e=Math.floor(r/o),i=r-e*o;let[c,u,d,h]=[0,0,0,0];for(let o=e*t;o<Math.min((e+1)*t,a);o++){const e=o*n;for(let a=i*t;a<Math.min((i+1)*t,n);a++){const t=4*(e+a);c+=s[t],u+=s[t+1],d+=s[t+2],h++}}[l[4*r],l[4*r+1],l[4*r+2],l[4*r+3]]=[c/h,u/h,d/h,255]}return l}(h.value,10)),x(e)):function(e){A.value||(A.value="MOVE",ue("*","cursor: move !important;",c=ce()),x(e))}(e)},startResize:function(e,{position:t,cursor:n}){A.value="RESIZE",r=t,ue("*",`cursor: ${n} !important;`,c=ce()),x(e)},handleToolCmd:function(e){switch(e){case"CANCEL":g()}},captureLayerStyle:d,mousePoint:a,RESIZE_POINTS:ye,RGB:o,captureLayer:S,infoBoxVisible:u,bound:T,canvasRef:P,wrapRef:t}}});const Me={ref:"wrapRef",class:"wrapper"};ge.render=function(e,t){const n=g("info-box"),a=g("tool-box");return m(),l(b,null,[r("div",Me,[r("canvas",{ref:"canvasRef",width:e.bound.x.max,height:e.bound.y.max},null,8,["width","height"]),r("div",{class:"capture-layer",style:e.captureLayerStyle,onMousedown:t[1]||(t[1]=(...t)=>e.onMousedownCaptureLayer&&e.onMousedownCaptureLayer(...t))},[(m(!0),l(b,null,x(e.RESIZE_POINTS,(t=>(m(),l("button",{key:t.position.join(),style:t.position.reduce(((e,t)=>Object.assign(e,{[t]:"-3px"})),{cursor:t.cursor}),class:"resize-point",onMousedown:_((n=>e.startResize(n,t)),["prevent"])},null,44,["onMousedown"])))),128))],36),e.infoBoxVisible?(m(),l(n,{key:0,"mouse-point":e.mousePoint,canvas:e.canvasRef},{default:M((()=>[r("p",null,w(e.captureLayer.w)+" x "+w(e.captureLayer.h),1),r("p",null,"RGB("+w(e.RGB)+")",1)])),_:1},8,["mouse-point","canvas"])):R("",!0)],512),r(a,{onDispatch:e.handleToolCmd},null,8,["onDispatch"])],64)},function(e,t){if(!t)return e();if(void 0===C){const e=document.createElement("link").relList;C=e&&e.supports&&e.supports("modulepreload")?"modulepreload":"preload"}return Promise.all(t.map((e=>{if(e in O)return;O[e]=!0;const t=e.endsWith(".css"),n=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${n}`))return;const a=document.createElement("link");return a.rel=t?"stylesheet":C,t||(a.as="script",a.crossOrigin=""),a.href=e,document.head.appendChild(a),t?new Promise(((e,t)=>{a.addEventListener("load",e),a.addEventListener("error",t)})):void 0}))).then((()=>e()))}((()=>__import__("./bigbadfox1080p.mkv_20201108_104416.220.8e277ed3.js")),void 0).then((e=>fetch(e.default))).then((e=>e.blob())).then((async e=>{await de(URL.createObjectURL(e),k),L(ge).mount("#app")}));
